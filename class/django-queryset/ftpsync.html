<div class="highlight"><pre><span class="c">#!/usr/bin/env python3</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">ftpsync.py -- transfer local files to FTP server</span>

<span class="sd">DO NOT USE -- use lftp command instead, start with &#39;cd /django-queryset ; mirror -v --reverse -X project --ignore-time --use-cache -X *.pickle -X *.doctree --dry-run&#39;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="c"># &quot;git ls-tree&quot; from http://stackoverflow.com/questions/1910783/git-1-list-all-files-in-a-branch-2-compare-files-from-different-branch</span>

<span class="kn">import</span> <span class="nn">itertools</span><span class="o">,</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">subprocess</span><span class="o">,</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">ftplib</span>
<span class="kn">from</span> <span class="nn">ftplib</span> <span class="kn">import</span> <span class="n">FTP</span>


<span class="k">def</span> <span class="nf">find_files</span><span class="p">(</span><span class="n">topdir</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">dirname</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">filenames</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">topdir</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">filenames</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirname</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>

<span class="c"># list files known to Git</span>
<span class="n">paths</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">(</span>
    <span class="s">&#39;git ls-tree -r --name-only HEAD&#39;</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&quot;utf-8&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>

<span class="c"># zap Django site</span>
<span class="n">paths</span> <span class="o">=</span> <span class="nb">filter</span><span class="p">(</span>
    <span class="k">lambda</span> <span class="n">path</span><span class="p">:</span> <span class="ow">not</span> <span class="n">path</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;project/&#39;</span><span class="p">),</span>
    <span class="n">paths</span><span class="p">)</span>

<span class="c"># add slides</span>
<span class="n">paths</span> <span class="o">=</span> <span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="p">(</span><span class="n">paths</span><span class="p">,</span> <span class="n">find_files</span><span class="p">(</span><span class="s">&#39;_build&#39;</span><span class="p">))</span>
<span class="n">paths</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">paths</span><span class="p">)</span>

<span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">paths</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

<span class="k">if</span> <span class="mi">0</span><span class="p">:</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="s">&#39;Transferring {} files&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">paths</span><span class="p">)))</span>

<span class="k">try</span><span class="p">:</span>
    <span class="n">user</span><span class="p">,</span><span class="n">pw</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s">&#39;FTP_AUTH&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;:&#39;</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s">&#39;usage: FTP_AUTH=(user):(pass) ftpsync.py&#39;</span><span class="p">)</span>

<span class="n">ftp</span> <span class="o">=</span> <span class="n">FTP</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s">&#39;ftp.ipage.com&#39;</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="n">user</span><span class="p">,</span> <span class="n">passwd</span><span class="o">=</span><span class="n">pw</span><span class="p">)</span>
<span class="k">if</span> <span class="mi">0</span><span class="p">:</span>
    <span class="n">ftp</span><span class="o">.</span><span class="n">set_debuglevel</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">ftp</span><span class="o">.</span><span class="n">cwd</span><span class="p">(</span><span class="s">&#39;django-queryset&#39;</span><span class="p">)</span>

    <span class="n">path</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">for</span> <span class="n">num</span><span class="p">,</span><span class="n">path</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">paths</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;{:3d}/{:3d} {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">num</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">paths</span><span class="p">),</span> <span class="n">path</span><span class="p">,</span>
            <span class="p">))</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;??&#39;</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="k">if</span> <span class="s">&#39;/&#39;</span> <span class="ow">in</span> <span class="n">path</span><span class="p">:</span>
            <span class="n">mydir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\t</span><span class="s">- mkdir {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mydir</span><span class="p">))</span>
            <span class="c"># ignore &#39;550 (mydir) File exists&#39;</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ftp</span><span class="o">.</span><span class="n">mkd</span><span class="p">(</span> <span class="n">mydir</span> <span class="p">)</span>
            <span class="k">except</span> <span class="n">ftplib</span><span class="o">.</span><span class="n">error_perm</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="c"># except ftplib.all_errors:</span>
            <span class="c">#     pass</span>

        <span class="n">ftp</span><span class="o">.</span><span class="n">storbinary</span><span class="p">(</span>
            <span class="s">&#39;STOR {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">),</span>
            <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s">&#39;rb&#39;</span><span class="p">)</span>
        <span class="p">)</span>
<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s">&#39;UHOH: {} path={}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">exc</span><span class="p">,</span> <span class="n">path</span><span class="p">))</span>
<span class="k">finally</span><span class="p">:</span>
    <span class="n">ftp</span><span class="o">.</span><span class="n">quit</span><span class="p">()</span>                  
</pre></div>
