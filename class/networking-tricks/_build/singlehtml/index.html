<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Networking Tricks with the Linux Kernel 2014.12.09 documentation</title>
    
    <link rel="stylesheet" href="_static/default.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '2014.12.09',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="None" href="index.html#document-index" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li><a href="index.html#document-index">Networking Tricks with the Linux Kernel 2014.12.09 documentation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="networking-tricks-with-the-linux-kernel">
<h1>Networking Tricks with the Linux Kernel<a class="headerlink" href="#networking-tricks-with-the-linux-kernel" title="Permalink to this headline">¶</a></h1>
<p><a class="reference external" href="http://johntellsall.com/networking-tricks">http://johntellsall.com/networking-tricks</a></p>
<p><strong>John Mitchell</strong></p>
<p>☃</p>
<p>next talk: Tuesday, on Django + Docker</p>
</div>
<div class="section" id="me">
<h1>Me<a class="headerlink" href="#me" title="Permalink to this headline">¶</a></h1>
<ul class="simple">
<li>Senior web/server consultant; DevOps</li>
<li>20 years experience with Python</li>
<li><a class="reference external" href="mailto:john&#37;&#52;&#48;johntellsall&#46;com">john<span>&#64;</span>johntellsall<span>&#46;</span>com</a></li>
</ul>
</div>
<div class="section" id="themes">
<h1>Themes<a class="headerlink" href="#themes" title="Permalink to this headline">¶</a></h1>
<p>apps talk to other apps</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>There are tons of kernel structures to make this happen &#8211; we&#8217;ll cover about a dozen types tonight.</p>
<p>Many are unknown or have subtle details.</p>
<p>It looks like it works one way, but there are important differences.</p>
<p class="last">and... DETAILS MATTER!</p>
</div>
</div>
<div class="section" id="id1">
<h1>.<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h1>
<div class="figure">
<img alt="_images/css-is-awesome-700x375.jpg" class="fill" src="_images/css-is-awesome-700x375.jpg" />
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">details matter!</p>
</div>
</div>
<div class="section" id="choose-your-own-tradeoffs">
<h1>choose your own tradeoffs<a class="headerlink" href="#choose-your-own-tradeoffs" title="Permalink to this headline">¶</a></h1>
<p><em>How</em> apps talk to each other matters:</p>
<ul class="simple">
<li>system does work =&gt; simpler code</li>
<li><em>you</em> know your app best</li>
</ul>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<ul class="last">
<li><p class="first">instead of “one size fits all” use specific features that fit your app</p>
<blockquote>
<div><p>=&gt; theme: concept doesn’t match implementation</p>
</div></blockquote>
</li>
</ul>
</div>
</div>
<div class="section" id="this-talk">
<h1>this talk<a class="headerlink" href="#this-talk" title="Permalink to this headline">¶</a></h1>
<ul class="simple">
<li>overview</li>
<li>tricks and awesomeness</li>
<li>other directions</li>
</ul>
</div>
<div class="section" id="what-is-the-kernel">
<h1>what is the kernel?<a class="headerlink" href="#what-is-the-kernel" title="Permalink to this headline">¶</a></h1>
</div>
<div class="section" id="id2">
<h1>.<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h1>
<div class="figure">
<img alt="_images/batman-secrets-of-the-batcave.jpg" class="fill" src="_images/batman-secrets-of-the-batcave.jpg" />
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<ul class="last simple">
<li>what _is_ the kernel? <a class="reference external" href="http://lwn.net/Articles/534682/">http://lwn.net/Articles/534682/</a></li>
</ul>
</div>
</div>
<div class="section" id="q-what-types-of-ipc-are-there">
<h1>Q: what types of IPC are there?<a class="headerlink" href="#q-what-types-of-ipc-are-there" title="Permalink to this headline">¶</a></h1>
</div>
<div class="section" id="overview-of-sockets">
<h1>Overview of Sockets<a class="headerlink" href="#overview-of-sockets" title="Permalink to this headline">¶</a></h1>
<ul class="simple">
<li>two (or more) processes</li>
<li>address for each end</li>
<li>connection-oriented or connectionless</li>
</ul>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>Everyone knows this stuff, but there’s a lot of details which can be subtle, or awesome.</p>
<p class="last">There will be a cheat sheet later</p>
</div>
</div>
<div class="section" id="tail-f-syslog-egrep-err">
<h1>tail -f syslog | egrep ERR<a class="headerlink" href="#tail-f-syslog-egrep-err" title="Permalink to this headline">¶</a></h1>
<p>good old <em>pipes</em></p>
<ul class="simple">
<li>connection-oriented</li>
<li>address: anonymous (or path)</li>
<li>one-way reliable stream of bytes</li>
<li>bytes consumed by sink</li>
</ul>
<div class="section" id="pipe">
<h2>pipe<a class="headerlink" href="#pipe" title="Permalink to this headline">¶</a></h2>
<div class="figure">
<img alt="_images/cam-pipe.jpg" class="fill" src="_images/cam-pipe.jpg" />
</div>
</div>
</div>
<div class="section" id="trick-file-path-network">
<h1>trick: file path = network<a class="headerlink" href="#trick-file-path-network" title="Permalink to this headline">¶</a></h1>
<p><em>named pipes</em> are awesome</p>
<p>anything with a <em>file address</em> (ie: path), can be connected to
anything that expects a file</p>
<div class="section" id="fifo">
<h2>fifo<a class="headerlink" href="#fifo" title="Permalink to this headline">¶</a></h2>
<div class="figure">
<img alt="_images/cam-named-pipe.jpg" class="fill" src="_images/cam-named-pipe.jpg" />
</div>
</div>
</div>
<div class="section" id="postgres-import-from-stream">
<h1>Postgres import from stream<a class="headerlink" href="#postgres-import-from-stream" title="Permalink to this headline">¶</a></h1>
<blockquote>
<div><p><tt class="docutils literal"><span class="pre">mkfifo</span> <span class="pre">--mode=0666</span> <span class="pre">/tmp/pipe</span></tt></p>
<p><tt class="docutils literal"><span class="pre">psql</span> <span class="pre">-c</span> <span class="pre">&quot;COPY</span> <span class="pre">x.x</span> <span class="pre">FROM</span> <span class="pre">'/tmp/pipe'</span></tt></p>
<p><tt class="docutils literal"><span class="pre">gunzip</span> <span class="pre">&lt;</span> <span class="pre">data.gz</span> <span class="pre">&gt;</span> <span class="pre">/tmp/pipe</span></tt></p>
</div></blockquote>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>/tmp/pipe is an <em>address</em> (file path)</p>
<p class="last">JM diagram</p>
</div>
</div>
<div class="section" id="internet-sockets">
<h1>Internet sockets<a class="headerlink" href="#internet-sockets" title="Permalink to this headline">¶</a></h1>
</div>
<div class="section" id="tcp-socket">
<h1>TCP socket<a class="headerlink" href="#tcp-socket" title="Permalink to this headline">¶</a></h1>
<blockquote>
<div><ul class="simple">
<li>connection-oriented</li>
<li>reliable stream of bytes</li>
<li>bytes consumed by sink</li>
<li><em>new</em>: bidirectional</li>
<li><em>new</em>: on each end is an “address”: IP address, a (TCP) port</li>
</ul>
</div></blockquote>
</div>
<div class="section" id="http-tcp">
<h1>HTTP(TCP)<a class="headerlink" href="#http-tcp" title="Permalink to this headline">¶</a></h1>
<div class="figure">
<img alt="_images/cam-http.jpg" class="fill" src="_images/cam-http.jpg" />
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<ul class="simple">
<li>address: anonymous (or path)</li>
</ul>
<p>Metaphor is a “pipe”: path with two endpoints &#8211; connection oriented
&#8211; reliable ordered stream of bytes.</p>
<p>Usage: client connects to endpoint on server, transfer data back and forth</p>
<p class="last">Example: used for web and tons of stuff.</p>
</div>
</div>
<div class="section" id="tcp-features">
<h1>TCP features<a class="headerlink" href="#tcp-features" title="Permalink to this headline">¶</a></h1>
<ul class="simple">
<li>automatic flow control</li>
<li>split/join packets</li>
<li><em>drawback:</em> latency</li>
</ul>
<p>more: &#8220;Hello, would you like to hear a TCP joke?&#8221;</p>
</div>
<div class="section" id="udp-socket">
<h1>UDP socket<a class="headerlink" href="#udp-socket" title="Permalink to this headline">¶</a></h1>
<ul class="simple">
<li>address: IP and port number</li>
<li>connectionless</li>
<li>fast, low latency</li>
<li>multicast is awesome</li>
<li>small <em>packets</em> not bytes</li>
<li><em>drawback:</em> unreliable: drops, dups, reordering</li>
</ul>
</div>
<div class="section" id="dns">
<h1>DNS<a class="headerlink" href="#dns" title="Permalink to this headline">¶</a></h1>
<div class="figure">
<img alt="_images/cam-dns.jpg" class="fill" src="_images/cam-dns.jpg" />
</div>
</div>
<div class="section" id="udp-how-do-you-know-what-went-wrong">
<h1>UDP: How do you know what went wrong?<a class="headerlink" href="#udp-how-do-you-know-what-went-wrong" title="Permalink to this headline">¶</a></h1>
<ul class="simple">
<li>server isn&#8217;t up</li>
<li>wrong IP / port</li>
<li>bad router</li>
<li>satellite link</li>
<li>overloaded server</li>
</ul>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">theme: details matter!</p>
</div>
</div>
<div class="section" id="answer">
<h1>Answer<a class="headerlink" href="#answer" title="Permalink to this headline">¶</a></h1>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>A: no response, so you’ll never know!</p>
<p class="last">theme: best tool for the job</p>
</div>
</div>
<div class="section" id="detail-udp-vs-tcp">
<h1>Detail: UDP vs TCP<a class="headerlink" href="#detail-udp-vs-tcp" title="Permalink to this headline">¶</a></h1>
<p>which is better?</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>connection oriented isn’t always the best: can’t interrupt
data flow; CPU has to examine each and every byte to figure out
where messages begin and end</p>
<p class="last">JM diagram</p>
</div>
</div>
<div class="section" id="q-how-reliable-is-udp">
<h1>Q: how reliable is UDP?<a class="headerlink" href="#q-how-reliable-is-udp" title="Permalink to this headline">¶</a></h1>
</div>
<div class="section" id="id3">
<h1>.<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h1>
<p>98% reliable!</p>
</div>
<div class="section" id="detail-udp-pseudo-connections">
<h1>Detail: UDP pseudo-connections<a class="headerlink" href="#detail-udp-pseudo-connections" title="Permalink to this headline">¶</a></h1>
<p>Q: for connectionless protocols (UDP), how does server know who to
send response to?</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">UDP: how do you know who sent you a packet?</p>
</div>
</div>
<div class="section" id="id4">
<h1>Answer<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h1>
<p>A: kernel gives you user data, but there’s also other data available
in the network headers</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>server bind: s.bind((HOST, PORT))
server: data,addr = s.recvfrom(1024)</p>
<p>client send: s.sendto(msg, (host, port))
client: reply,addr = s.recvfrom(1024)</p>
<p class="last">(JM: how?)  IP header has client’s IP.
(JM: what about UDP port?)
(JM: example UDP “send to client”)</p>
</div>
</div>
<div class="section" id="unix-domain-sockets">
<h1>Unix domain sockets<a class="headerlink" href="#unix-domain-sockets" title="Permalink to this headline">¶</a></h1>
<ul class="simple">
<li>best of all worlds</li>
<li>connection-oriented</li>
<li>reliable stream of bytes</li>
<li>bidirectional</li>
<li><em>new</em>: secure: data doesn’t travel across a network</li>
<li><em>new</em>: fast, low latency</li>
</ul>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<ul class="simple">
<li>common: connection-oriented reliable stream of bytes, like TCP but same machine only</li>
<li>similar to pipe: AF: path, Linux Abstract “later”</li>
<li>like TCP: bidirectional</li>
<li>fast</li>
<li>low latency</li>
<li>can _choose_ speed vs inorder, connection vs connectionless</li>
</ul>
<p class="last">later: <a class="reference external" href="http://www.thomasstover.com/uds.html">http://www.thomasstover.com/uds.html</a> Demystifying Unix Domain Sockets</p>
</div>
</div>
<div class="section" id="id5">
<h1>☃<a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h1>
</div>
<div class="section" id="cool-networking-tricks">
<h1>Cool Networking Tricks<a class="headerlink" href="#cool-networking-tricks" title="Permalink to this headline">¶</a></h1>
</div>
<div class="section" id="linux-flavor-af-unix-is-awesome">
<h1>Linux-flavor AF_UNIX is awesome<a class="headerlink" href="#linux-flavor-af-unix-is-awesome" title="Permalink to this headline">¶</a></h1>
<p>fast, low-latency, reliable, and:</p>
<ul class="simple">
<li>byte- or packet-based!</li>
<li>multicast!</li>
<li>message bus!</li>
<li>&gt; 2 processes!</li>
</ul>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>This means that if you have two or more processes on the same
machine, you have a wide range of options, including skipping
distributed queues like Redis Detail: and sequential packets</p>
<ul class="last simple">
<li>JM: expand</li>
</ul>
</div>
</div>
<div class="section" id="extra-special-features">
<h1>Extra special features<a class="headerlink" href="#extra-special-features" title="Permalink to this headline">¶</a></h1>
<ul class="simple">
<li>send “file descriptor” to unrelated process</li>
<li>send credentials to other process</li>
</ul>
</div>
<div class="section" id="cheat-sheet">
<h1>Cheat Sheet<a class="headerlink" href="#cheat-sheet" title="Permalink to this headline">¶</a></h1>
<p>develop in this order:</p>
<ul class="simple">
<li><strong>TCP</strong></li>
<li><strong>Unix domain</strong></li>
<li><strong>UDP</strong></li>
<li><strong>TCP</strong></li>
</ul>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<ul class="simple">
<li>reliable</li>
<li>simple</li>
<li>go through firewalls</li>
<li>adapt themselves to traffic</li>
<li>very well-understood</li>
<li>get message or error</li>
</ul>
<p>use UDP packets:
* fast
* low latency
* don’t have to parse messages
* can’t get partial message
* TCP stream you can’t interrupt
* same machine: no dups, drops, or latency</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<ul class="last simple">
<li>good for stats</li>
</ul>
</div>
<p>UNIX-domain sockets are generally more flexible than named pipes. Some of their advantages are:
* You can use them for more than two processes communicating (eg. a server process with potentially multiple client processes connecting);
* They are bidirectional;
* They support passing kernel-verified UID / GID credentials between processes;
* They support passing file descriptors between processes;
* They support packet and sequenced packet modes.</p>
<p class="last"><a class="reference external" href="http://stackoverflow.com/questions/9475442/unix-domain-socket-vs-named-pipes">http://stackoverflow.com/questions/9475442/unix-domain-socket-vs-named-pipes</a></p>
</div>
</div>
<div class="section" id="udp-vs-tcp">
<h1>UDP vs TCP<a class="headerlink" href="#udp-vs-tcp" title="Permalink to this headline">¶</a></h1>
<p>faster?</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">we’ve talked about fast unreliable UDP and connection-oriented TCP &#8211; what’s faster: Unix domain socket or TCP?</p>
</div>
</div>
<div class="section" id="trick-friend-sockets">
<h1>trick: &#8220;friend&#8221; sockets<a class="headerlink" href="#trick-friend-sockets" title="Permalink to this headline">¶</a></h1>
<p>A: for lots of connections:</p>
<p>&#8220;friend&#8221; TCP up to <em>3x</em> faster than Unix domain</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last"><a class="reference external" href="http://lwn.net/Articles/511079/">http://lwn.net/Articles/511079/</a></p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>TCP socket as stream of bytes: using sendmsg(), server can start
workers, accept a socket, then reconnect socket to already running
worker, then continue listening.</p>
<p>=&gt; theme: details matter</p>
<p class="last">“Unlike stream sockets (tcp or unix domain), datagram sockets need
endpoints defined for both the server AND the client. When one
establishes a connection in stream sockets, an endpoint for the
client is implicitly created by the operating system. Whether this
corresponds to an ephemeral TCP/UDP port, or a temporary inode for
the unix domain, the endpoint for the client is created for
you. Thats why you don&#8217;t normally need to issue a call to bind()
for stream sockets in the client.”
<a class="reference external" href="http://stackoverflow.com/questions/3324619/unix-domain-socket-using-datagram-communication-between-one-server-process-and">http://stackoverflow.com/questions/3324619/unix-domain-socket-using-datagram-communication-between-one-server-process-and</a></p>
</div>
</div>
<div class="section" id="id6">
<h1>☃<a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h1>
</div>
<div class="section" id="everything-is-awesome">
<h1>Everything is Awesome<a class="headerlink" href="#everything-is-awesome" title="Permalink to this headline">¶</a></h1>
<p><em>future directions</em></p>
</div>
<div class="section" id="containers">
<h1>Containers<a class="headerlink" href="#containers" title="Permalink to this headline">¶</a></h1>
</div>
<div class="section" id="hardware-ring-buffer">
<h1>hardware ring buffer<a class="headerlink" href="#hardware-ring-buffer" title="Permalink to this headline">¶</a></h1>
<p>10x performance ...</p>
<p>... at the cost of doing everything yourself!</p>
<img alt="_images/specialization.jpg" src="_images/specialization.jpg" />
<div class="admonition note">
<p class="first admonition-title">Note</p>
<ul class="simple">
<li><a class="reference external" href="http://highscalability.com/blog/2014/2/12/paper-network-stack-specialization-for-performance.html">http://highscalability.com/blog/2014/2/12/paper-network-stack-specialization-for-performance.html</a></li>
</ul>
<p class="last">... at the cost of
direct hardware ring buffer to communicate. 10x performance, at the cost of abandoning a lot of Linux services XX link</p>
</div>
</div>
<div class="section" id="intra-cluster-communication">
<h1>intra-cluster communication<a class="headerlink" href="#intra-cluster-communication" title="Permalink to this headline">¶</a></h1>
<ul class="simple">
<li>direct support for multiple data centers</li>
<li>addr per machine not adapter</li>
<li>addr 32 bit not IP</li>
<li>Transparent Inter-Process Communication, or...</li>
</ul>
<div class="section" id="tipc">
<h2>TIPC<a class="headerlink" href="#tipc" title="Permalink to this headline">¶</a></h2>
<img alt="_images/tipsy.png" src="_images/tipsy.png" />
</div>
</div>
<div class="section" id="thanks">
<h1>Thanks!<a class="headerlink" href="#thanks" title="Permalink to this headline">¶</a></h1>
<ul class="simple">
<li><strong>Q Carolyn</strong></li>
<li><strong>Jordan</strong></li>
<li><strong>Goz</strong></li>
</ul>
</div>
<div class="section" id="questions">
<h1>Questions?<a class="headerlink" href="#questions" title="Permalink to this headline">¶</a></h1>
<div class="figure">
<img alt="_images/john-bold.jpg" class="fill" src="_images/john-bold.jpg" />
<p class="caption"><a class="reference external" href="mailto:john&#37;&#52;&#48;johntellsall&#46;com">john<span>&#64;</span>johntellsall<span>&#46;</span>com</a></p>
</div>
</div>
<div class="section" id="next-talk">
<h1>Next Talk<a class="headerlink" href="#next-talk" title="Permalink to this headline">¶</a></h1>
<p><strong>Docker Django stack in Five Minutes</strong></p>
<p>Tuesday!</p>
<p>LA Django meetup</p>
</div>
<div class="section" id="apache">
<h1>Apache<a class="headerlink" href="#apache" title="Permalink to this headline">¶</a></h1>
<div class="figure">
<img alt="_images/john-bold.jpg" class="fill" src="_images/john-bold.jpg" />
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li><a href="index.html#document-index">Networking Tricks with the Linux Kernel 2014.12.09 documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2014, John Mitchell.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.1.
    </div>
  </body>
</html>